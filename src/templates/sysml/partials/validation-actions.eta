<% if (it.sourceFileErrors && it.sourceFileErrors.length > 0) { %>
## Invalid @SourceFile References (HIGH PRIORITY)

These source file paths don't exist in the repository:
<% for (const err of it.sourceFileErrors.slice(0, 10)) { %>
- `<%= err.sysmlFile %>:<%= err.line %>` → `<%= err.referencedPath %>`
<% } %>
<% if (it.sourceFileErrors.length > 10) { %>
*(+<%= it.sourceFileErrors.length - 10 %> more)*
<% } %>

**Fix**: Update the @SourceFile path to reference an existing file, or remove the metadata if the source is no longer relevant.

<% } %>
<% if (it.validationExitCode && it.validationExitCode !== 0) { %>
## Fix Validation Errors First

**Prioritize fixing these errors before adding new SysML definitions.**

<% if (it.validationExitCode === 1) { %>
### Syntax Errors (exit code 1)
Syntax errors block all semantic analysis. Fix these first:
1. Review the error details in the validation output above
2. Use `SysMLWrite` to correct malformed definitions
3. Errors will be re-validated automatically after each write

<% } else if (it.validationExitCode === 2) { %>
### Semantic Errors (exit code 2)
These are undefined references or type mismatches:

**Common errors and fixes:**
- **E3006 "cannot be typed by"**: The type exists but can't be used as a typing relationship. Use `:>` (specializes) instead of `:` for item definitions, or ensure you're referencing the correct type.
- **E3001 "undefined type"**: Create the missing type definition, or add an import if it exists elsewhere.
- **E3002 "feature not found"**: The referenced feature doesn't exist in the parent type.
  **Most common cause**: Using `part :>> name` as a direct child of a package. Packages don't inherit features — use `part name : Type { }` instead of `part :>> name`. Check the parent definition and fix the reference.
  **NEVER delete type definitions to fix E3002** — deleting `port def`, `item def`, `part def`, etc. causes cascading E3001 errors. Use SysMLWrite upsert to fix definitions in-place.
  **Recovery steps for E3002:**
  1. `SysMLRead` the file to find all `:>>` lines causing E3002
  2. Use `SysMLWrite` upsert to REPLACE each broken element with correct syntax: `part name : Type { ... }` (no `:>>`)
  3. Do NOT try to delete first — upsert handles replacement atomically
  4. If the `:>>` is inside a definition (not a package), verify the parent type actually defines the feature being redefined
- **E3003 "undefined namespace"**: The imported package doesn't exist. Create the package file FIRST, then import it.

**Important: Delete operations and semantic errors:**
Delete operations may fail when pre-existing semantic errors (E3xxx) exist in the file. If a delete keeps failing with the same error, use SysMLWrite upsert to replace the broken element with a corrected version instead of trying to delete it.

**CRITICAL: NEVER delete type definitions** (`port def`, `item def`, `part def`, `action def`, `enum def`, `state def`, `interface def`) to resolve any error. Use SysMLWrite upsert to fix them in-place.

**Workflow:**
1. Use `SysMLRead` to inspect the file containing the error
2. If needed, `ReadFiles` to check how the type is used in source code
3. `SysMLWrite` to fix the specific issue (prefer upsert over delete for broken elements)
4. Repeat until validation passes

<% } %>
<% } else if (it.validationExitCode === 0 && it.validationOutput && it.validationOutput.includes('warning')) { %>
### Warnings (must fix)
- **W1003 "instantiation of abstract type"**: You are using an abstract type directly.
  - For entities: use `:> BaseEntity` not `:> Item`
  - For DTOs: use `:> BaseDTO` not `:> Item`
  - For events: use `:> BaseDomainEvent` not `:> Item`
  - For requirements: use `:> BaseRequirement`
  - For polymorphic fields (can hold any item): use `: AnyItem` not `: Item`
  - Fix these before proceeding - they indicate incorrect type usage.

<% } %>

## Gadget Selection Guide

**Before writing SysML, determine which gadget to use:**

| Situation | Gadget | Example |
|-----------|--------|---------|
| File doesn't exist | `SysMLCreate` | `SysMLCreate(path="data/enums.sysml", package="DomainEnums")` |
| File exists, add/update content | `SysMLWrite` | `SysMLWrite(path="data/enums.sysml", element="...", at="DomainEnums")` |
| File exists, fix ordering (E3002) | `SysMLWrite` | Use upsert to fix definitions. NEVER delete type definitions |
| File corrupted/unrecoverable | `SysMLCreate` | Use `force=true` only for syntax errors that can't be fixed |

**CRITICAL: NEVER use SysMLCreate on existing files without `force=true`!**
- If you get "file already exists" error, switch to `SysMLWrite` with `at` parameter
- `SysMLCreate` is for NEW files only
- `SysMLWrite(element="...", at="Pkg")` adds/updates elements in existing files
